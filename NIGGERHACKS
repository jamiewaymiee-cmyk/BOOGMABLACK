-- ==============================================================================
-- SUGMAHACKS - KEYBIND EDITION (FIXED & OPTIMIZED)
-- Features: Aimbot, ESP, FOV Control (No GUI)
-- Fixes: Unified ValidTargets table, Dead Check (Health > 0)
-- ==============================================================================

local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")

local Player = Players.LocalPlayer
local Camera = Workspace.CurrentCamera

-- ==================== EDITABLE CONFIGURATION ====================

local Config = {
    Aimbot = {
        Enabled = false,       -- Toggled by '['
        AimPart = "Head",      -- Part to aim at
        Smoothness = 6,        -- 1 = Instant, 10 = Very Smooth
        DeadZone = 4,          -- Pixels (prevents shaking)
        TriggerKey = Enum.UserInputType.MouseButton2 -- Right Click to aim
    },
    ESP = {
        Enabled = false,       -- Toggled by ']'
        ScanInterval = 0.5     -- How often to look for new enemies
    },
    FOV = {
        Value = 100,           -- Base FOV
        Visible = true,        -- Show the circle?
        Color = Color3.fromRGB(255, 0, 127)
    }
}

-- ==================== VARIABLES ====================

local ValidTargets = {} -- Shared table for LIVING players
local ESP_OBJECTS = {}
local LockedTarget = nil
local LockTime = 0

-- FOV Circle Drawing
local FOVCircle = Drawing.new("Circle")
FOVCircle.Thickness = 2
FOVCircle.Color = Config.FOV.Color
FOVCircle.Filled = false
FOVCircle.Radius = Config.FOV.Value
FOVCircle.Visible = false
FOVCircle.Transparency = 1

-- ==================== HELPER FUNCTIONS ====================

local function SendNotification(text)
    print(">> [SUGMA]: " .. text)
end

local function isTriggerHeld()
    return UserInputService:IsMouseButtonPressed(Config.Aimbot.TriggerKey)
end

-- DEAD CHECK / VALIDATION
local function IsValidTarget(model)
    if not model or not model.Parent then return false end
    if model.Name ~= "Male" then return false end -- Target name check
    
    -- Check Life State
    local humanoid = model:FindFirstChildOfClass("Humanoid")
    if not humanoid then return false end
    if humanoid.Health <= 0 then return false end -- IGNORES DEAD PEOPLE
    
    -- Check Parts
    local head = model:FindFirstChild(Config.Aimbot.AimPart)
    local root = model:FindFirstChild("Root") or model:FindFirstChild("HumanoidRootPart")
    
    if not head or not root then return false end

    return true
end

-- ==================== ESP SYSTEM ====================

local function ClearESP()
    for _, data in pairs(ESP_OBJECTS) do
        if data.Highlight then data.Highlight:Destroy() end
        if data.Billboard then data.Billboard:Destroy() end
    end
    table.clear(ESP_OBJECTS)
end

local function UpdateESP()
    if not Config.ESP.Enabled then return end

    -- 1. Remove Invalid/Dead ESP
    for model, data in pairs(ESP_OBJECTS) do
        if not IsValidTarget(model) then
            if data.Highlight then data.Highlight:Destroy() end
            if data.Billboard then data.Billboard:Destroy() end
            ESP_OBJECTS[model] = nil
        end
    end

    -- 2. Add New ESP from Shared Table
    for _, model in ipairs(ValidTargets) do
        if not ESP_OBJECTS[model] then
            local root = model:FindFirstChild("Root") or model:FindFirstChild("HumanoidRootPart")
            if root then
                local highlight = Instance.new("Highlight")
                highlight.FillColor = Color3.fromRGB(255, 0, 0)
                highlight.OutlineColor = Color3.fromRGB(255, 255, 255)
                highlight.FillTransparency = 0.6
                highlight.OutlineTransparency = 0
                highlight.Adornee = model
                highlight.Parent = model

                local billboard = Instance.new("BillboardGui")
                billboard.Size = UDim2.new(0, 100, 0, 40)
                billboard.StudsOffset = Vector3.new(0, 3, 0)
                billboard.AlwaysOnTop = true
                billboard.Adornee = root
                billboard.Parent = model

                local text = Instance.new("TextLabel")
                text.Size = UDim2.new(0.5, 0, 0.5, 0)
                text.BackgroundTransparency = 1
                text.TextColor3 = Color3.new(1, 1, 1)
                text.TextStrokeTransparency = 0
                text.TextScaled = true
                text.Font = Enum.Font.SourceSansBold
                text.Text = "0 studs"
                text.Parent = billboard

                ESP_OBJECTS[model] = {
                    Highlight = highlight,
                    Billboard = billboard,
                    Label = text,
                    Root = root
                }
            end
        end
    end
end

-- ==================== AIMBOT SYSTEM ====================

local function GetClosestTarget()
    local closestPart = nil
    local shortestDist = Config.FOV.Value
    local mousePos = UserInputService:GetMouseLocation()

    -- Sticky Target Logic (Keeps aiming at target until dead or key released)
    if LockedTarget and LockedTarget.Parent and IsValidTarget(LockedTarget.Parent) then
        local pos, onScreen = Camera:WorldToViewportPoint(LockedTarget.Position)
        if onScreen then
            local dist = (Vector2.new(pos.X, pos.Y) - mousePos).Magnitude
            if dist <= Config.FOV.Value * 1.5 then return LockedTarget end
        end
    end

    -- Find New Target (Using the shared ValidTargets table)
    for _, model in ipairs(ValidTargets) do
        local part = model:FindFirstChild(Config.Aimbot.AimPart)
        if part then
            local pos, onScreen = Camera:WorldToViewportPoint(part.Position)
            if onScreen then
                local dist = (Vector2.new(pos.X, pos.Y) - mousePos).Magnitude
                if dist < shortestDist then
                    closestPart = part
                    shortestDist = dist
                end
            end
        end
    end
    return closestPart
end

local function SmoothMove(targetPos, deltaTime)
    local screenPos, onScreen = Camera:WorldToViewportPoint(targetPos)
    if not onScreen then return end

    local mousePos = UserInputService:GetMouseLocation()
    local targetScreen = Vector2.new(screenPos.X, screenPos.Y)
    local delta = targetScreen - mousePos
    local dist = delta.Magnitude

    if dist < Config.Aimbot.DeadZone then return end

    local smoothFactor = math.min(1, (deltaTime * 60) / Config.Aimbot.Smoothness)
    local moveAmount = delta * smoothFactor

    if mousemoverel then
        mousemoverel(moveAmount.X, moveAmount.Y)
    end
end

-- ==================== MAIN INPUT HANDLER ====================

UserInputService.InputBegan:Connect(function(input, gp)
    if gp then return end

    -- Toggle Aimbot
    if input.KeyCode == Enum.KeyCode.LeftBracket then -- '['
        Config.Aimbot.Enabled = not Config.Aimbot.Enabled
        SendNotification("Aimbot: " .. tostring(Config.Aimbot.Enabled))
    end

    -- Toggle ESP
    if input.KeyCode == Enum.KeyCode.RightBracket then -- ']'
        Config.ESP.Enabled = not Config.ESP.Enabled
        if not Config.ESP.Enabled then
            ClearESP()
        end
        SendNotification("ESP: " .. tostring(Config.ESP.Enabled))
    end

    -- FOV UP (Right Control)
    if input.KeyCode == Enum.KeyCode.RightControl then
        Config.FOV.Value = Config.FOV.Value + 50
        SendNotification("FOV: " .. Config.FOV.Value)
    end

    -- FOV DOWN (Right Alt)
    if input.KeyCode == Enum.KeyCode.RightAlt then
        Config.FOV.Value = math.max(50, Config.FOV.Value - 50)
        SendNotification("FOV: " .. Config.FOV.Value)
    end
end)

-- ==================== BACKGROUND LOOPS ====================

-- 1. Unified Scanner Loop (Updates ValidTargets for both Aimbot and ESP)
task.spawn(function()
    while true do
        local tempTargets = {}
        for _, obj in ipairs(Workspace:GetChildren()) do
            if IsValidTarget(obj) then
                table.insert(tempTargets, obj)
            end
        end
        ValidTargets = tempTargets -- Update global table
        
        if Config.ESP.Enabled then
            UpdateESP()
        end
        
        task.wait(Config.ESP.ScanInterval)
    end
end)

-- 2. Render Loop (Visuals + Aimbot Movement)
local lastFrameTime = tick()
RunService.RenderStepped:Connect(function()
    local currentTime = tick()
    local deltaTime = currentTime - lastFrameTime
    lastFrameTime = currentTime

    -- Draw FOV
    FOVCircle.Visible = Config.Aimbot.Enabled and Config.FOV.Visible
    FOVCircle.Radius = Config.FOV.Value
    FOVCircle.Position = UserInputService:GetMouseLocation()

    -- Run Aimbot
    local aimTarget = nil
    
    if Config.Aimbot.Enabled and isTriggerHeld() then
        aimTarget = GetClosestTarget()
        if aimTarget then
            LockedTarget = aimTarget
            FOVCircle.Color = Color3.fromRGB(0, 255, 0) -- Green when locked
            SmoothMove(aimTarget.Position, deltaTime)
        else
            LockedTarget = nil
            FOVCircle.Color = Config.FOV.Color
        end
    else
        LockedTarget = nil
        FOVCircle.Color = Config.FOV.Color
    end

    -- Run ESP Distance Updates
    if Config.ESP.Enabled then
        local camPos = Camera.CFrame.Position
        for model, data in pairs(ESP_OBJECTS) do
            -- Double check validity per frame for instant removal on death
            if not IsValidTarget(model) then
                if data.Highlight then data.Highlight:Destroy() end
                if data.Billboard then data.Billboard:Destroy() end
                ESP_OBJECTS[model] = nil
            else
                local dist = (camPos - data.Root.Position).Magnitude
                data.Label.Text = math.floor(dist) .. " studs"
            end
        end
    end
end)

SendNotification("Loaded")
